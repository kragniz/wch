#!/usr/bin/env python
import os
import re

LOG_FILE = '.wch'

def check_filetype(f):
    filetypes = ['mkv', 'mp4', 'avi']
    return True in [f.endswith(filetype) for filetype in filetypes]

def playlist():
    return _sort([f for f in os.listdir('.') if check_filetype(f)])

def load_config():
    if os.path.isfile(LOG_FILE):
        with open(LOG_FILE) as f:
            num = int(f.readline())
            t = int(f.readline())
    else:
        num, t = 0, 0
    return num, t

def _key(s):
    return [int(c) if c.isdigit() else c for c in re.split('([0-9]+)', s)][1:]

def _sort(l):
    convert = lambda text: int(text) if text.isdigit() else text 
    alphanum = lambda key: [convert(c) for c in re.split('([0-9]+)', key)]
    return sorted(l, key=_key)

def play(filename, num, time):
    d = os.getcwd()
    path = os.path.join(d, filename)
    return os.system(
            'mplayer -ss {time} -heartbeat-cmd "wch_log {num}" "{path}"'
            .format(time=time, path=path, num=num))

if __name__ == '__main__':
    import sys
    args = sys.argv
    if len(args) > 1:
        os.chdir(args[1])
    ep, time = load_config()
    for a in playlist():
        print a
        if play(a, ep, time) == 2:
            #C-c
            break
