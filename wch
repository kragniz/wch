#!/usr/bin/env python
import os
import re
import subprocess
import json

LOG_FILE = '.wch'

def check_filetype(f):
    filetypes = ['mkv', 'mp4', 'avi']
    return True in [f.endswith(filetype) for filetype in filetypes]

def init_playlist(files):
    return {f:False for f in files if check_filetype(f)}

def save_playlist(p):
    json.dump(p, open(LOG_FILE, 'w'))

def load_playlist():
    return json.load(open(LOG_FILE))

def sort_and_trim(d):
    return _sort(f for f in d if not d[f])

def _key(s):
    return [int(c) if c.isdigit() else c for c in re.split('([0-9]+)', s)][1:]

def _sort(l):
    convert = lambda text: int(text) if text.isdigit() else text 
    alphanum = lambda key: [convert(c) for c in re.split('([0-9]+)', key)]
    return sorted(l, key=_key)

def play(filename):
    d = os.getcwd()
    path = os.path.join(d, filename)
    return subprocess.call(['mplayer', path],
                            stderr=subprocess.STDOUT,
                            stdout=subprocess.PIPE)

if __name__ == '__main__':
    import sys
    args = sys.argv
    if len(args) > 1:
        if args[1] == 'init':
            if len(args) > 2:
                p = init_playlist(args[1:])
                save_playlist(p)

        elif args[1] == 'next' or args[1] == 'n':
            p = load_playlist()
            n = sort_and_trim(p)[0]
            print 'playing', n
            play(n)
            del p[n]
            save_playlist(p)
        else:
            print 'wch: "{}" is not a wch command'.format(args[1])
